│ Plan to implement                                                                                                    │
│                                                                                                                      │
│ Plan: Refactor Procedural Scripts to OOP Classes                                                                     │
│                                                                                                                      │
│ Context                                                                                                              │
│                                                                                                                      │
│ ระบบปัจจุบันมี 5 script files ที่เขียนแบบ procedural (top-level functions ล้วน ไม่มี class เลย) และ server.dart เรียก script    │
│ ทุกตัวผ่าน Process.run('dart', ['run', script]) ซึ่ง spawn process ใหม่ทุกครั้ง                                               │
│                                                                                                                      │
│ การ refactor เป็น OOP จะ:                                                                                             │
│ 1. ทำให้โค้ดตรงกับ Package Diagram ที่วาดไว้ (class = กล่องใน diagram)                                                      │
│ 2. เลิก spawn process → เรียก method ตรง (เร็วขึ้น)                                                                       │
│ 3. Dependency Injection ได้ (inject API key, PICT path ผ่าน constructor)                                               │
│ 4. เลิก workaround temp file สำหรับ constraints                                                                        │
│                                                                                                                      │
│ Files to Modify                                                                                                      │
│ ┌─────┬───────────────────────────────────────────┬────────────────────────────────────────────────────────────┐     │
│ │  #  │                   File                    │                           Change                           │     │
│ ├─────┼───────────────────────────────────────────┼────────────────────────────────────────────────────────────┤     │
│ │ 1   │ tools/script_v2/extract_ui_manifest.dart  │ Wrap in UiManifestExtractor class                          │     │
│ ├─────┼───────────────────────────────────────────┼────────────────────────────────────────────────────────────┤     │
│ │ 2   │ tools/script_v2/generate_datasets.dart    │ Wrap in DatasetGenerator class                             │     │
│ ├─────┼───────────────────────────────────────────┼────────────────────────────────────────────────────────────┤     │
│ │ 3   │ tools/script_v2/generate_test_data.dart   │ Wrap in TestDataGenerator class                            │     │
│ ├─────┼───────────────────────────────────────────┼────────────────────────────────────────────────────────────┤     │
│ │ 4   │ tools/script_v2/generate_test_script.dart │ Wrap in TestScriptGenerator class                          │     │
│ ├─────┼───────────────────────────────────────────┼────────────────────────────────────────────────────────────┤     │
│ │ 5   │ webview/server.dart                       │ Wrap in PipelineController class + import classes directly │     │
│ └─────┴───────────────────────────────────────────┴────────────────────────────────────────────────────────────┘     │
│ No changes: utils.dart, generator_pict.dart, webview/main.js, webview/index.html                                     │
│                                                                                                                      │
│ Phase 1: Wrap Scripts in Classes (files 1-4)                                                                         │
│                                                                                                                      │
│ For each script: wrap all functions inside a class, keep main() outside as CLI entry point.                          │
│                                                                                                                      │
│ 1.1 extract_ui_manifest.dart → UiManifestExtractor                                                                   │
│                                                                                                                      │
│ class UiManifestExtractor {                                                                                          │
│   const UiManifestExtractor();                                                                                       │
│                                                                                                                      │
│   /// แทน processUiFile() เดิม                                                                                        │
│   String extractManifest(String dartFilePath) { ... }                                                                │
│                                                                                                                      │
│   // ย้าย private functions ทั้งหมดมาเป็น private methods:                                                               │
│   // _processOne, _stripComments, _scanWidgets, _findPageClass,                                                      │
│   // _findCubitType, _findStateType, _matchParen, _matchBrace,                                                       │
│   // _extractKey, _extractTextBinding, _extractTextFieldMeta,                                                        │
│   // _extractValidationMeta, _extractRadioMeta, _scanDateTimePickers, ...                                            │
│ }                                                                                                                    │
│                                                                                                                      │
│ // main() ยังอยู่ข้างนอก class → CLI ยังใช้ได้                                                                              │
│ void main(List<String> args) {                                                                                       │
│   final extractor = UiManifestExtractor();                                                                           │
│   for (final p in args) {                                                                                            │
│     extractor.extractManifest(p);                                                                                    │
│   }                                                                                                                  │
│ }                                                                                                                    │
│                                                                                                                      │
│ 1.2 generate_datasets.dart → DatasetGenerator                                                                        │
│                                                                                                                      │
│ class DatasetGenerator {                                                                                             │
│   final String model;                                                                                                │
│   final String? apiKey;                                                                                              │
│   const DatasetGenerator({this.model = 'gemini-2.5-flash', this.apiKey});                                            │
│                                                                                                                      │
│   /// แทน generateDatasetsFromManifest() เดิม                                                                         │
│   /// Returns path หรือ null (skip เพราะไม่มี text fields)                                                              │
│   Future<String?> generateDatasets(String manifestPath) async { ... }                                                │
│                                                                                                                      │
│   // _processManifest, _callGeminiForDatasets,                                                                       │
│   // _extractTextFromGemini, _stripCodeFences                                                                        │
│ }                                                                                                                    │
│                                                                                                                      │
│ void main(List<String> args) async {                                                                                 │
│   // parse --model, --api-key flags                                                                                  │
│   final generator = DatasetGenerator(model: model, apiKey: apiKey);                                                  │
│   await generator.generateDatasets(manifestPath);                                                                    │
│ }                                                                                                                    │
│                                                                                                                      │
│ 1.3 generate_test_data.dart → TestDataGenerator                                                                      │
│                                                                                                                      │
│ class TestDataGenerator {                                                                                            │
│   final String pictBin;                                                                                              │
│   const TestDataGenerator({this.pictBin = './pict'});                                                                │
│                                                                                                                      │
│   /// แทน generateTestDataFromManifest() เดิม                                                                         │
│   Future<String> generateTestData(String manifestPath, {String? constraints}) async { ... }                          │
│                                                                                                                      │
│   // _processOne, _tryWritePictModelFromManifestForUi, ...                                                           │
│ }                                                                                                                    │
│                                                                                                                      │
│ void main(List<String> args) async {                                                                                 │
│   // parse --constraints-file flag                                                                                   │
│   final generator = TestDataGenerator();                                                                             │
│   await generator.generateTestData(path, constraints: constraints);                                                  │
│ }                                                                                                                    │
│                                                                                                                      │
│ 1.4 generate_test_script.dart → TestScriptGenerator                                                                  │
│                                                                                                                      │
│ class TestScriptGenerator {                                                                                          │
│   const TestScriptGenerator();                                                                                       │
│                                                                                                                      │
│   /// แทน generateTestScriptFromTestData() เดิม                                                                       │
│   String generateTestScript(String testDataPath) { ... }                                                             │
│                                                                                                                      │
│   // _processOne, _generateIntegrationTests, ...                                                                     │
│ }                                                                                                                    │
│                                                                                                                      │
│ void main(List<String> args) {                                                                                       │
│   final generator = TestScriptGenerator();                                                                           │
│   for (final path in args) {                                                                                         │
│     generator.generateTestScript(path);                                                                              │
│   }                                                                                                                  │
│ }                                                                                                                    │
│                                                                                                                      │
│ Phase 2: Refactor server.dart (file 5)                                                                               │
│                                                                                                                      │
│ 2.1 Add imports + Create PipelineController class                                                                    │
│                                                                                                                      │
│ // เพิ่ม imports (แทน runDartScript)                                                                                   │
│ import '../tools/script_v2/extract_ui_manifest.dart' show UiManifestExtractor;                                       │
│ import '../tools/script_v2/generate_datasets.dart' show DatasetGenerator;                                            │
│ import '../tools/script_v2/generate_test_data.dart' show TestDataGenerator;                                          │
│ import '../tools/script_v2/generate_test_script.dart' show TestScriptGenerator;                                      │
│                                                                                                                      │
│ class PipelineController {                                                                                           │
│   final UiManifestExtractor _extractor;                                                                              │
│   final DatasetGenerator _datasetGenerator;                                                                          │
│   final TestDataGenerator _testDataGenerator;                                                                        │
│   final TestScriptGenerator _testScriptGenerator;                                                                    │
│                                                                                                                      │
│   PipelineController({                                                                                               │
│     UiManifestExtractor? extractor,                                                                                  │
│     DatasetGenerator? datasetGenerator,                                                                              │
│     TestDataGenerator? testDataGenerator,                                                                            │
│     TestScriptGenerator? testScriptGenerator,                                                                        │
│   })  : _extractor = extractor ?? const UiManifestExtractor(),                                                       │
│         _datasetGenerator = datasetGenerator ?? const DatasetGenerator(),                                            │
│         _testDataGenerator = testDataGenerator ?? const TestDataGenerator(),                                         │
│         _testScriptGenerator = testScriptGenerator ?? const TestScriptGenerator();                                   │
│                                                                                                                      │
│   // ย้าย handleRequest, handleScan, handleExtractManifest, ... ทั้งหมดเข้า class                                        │
│   // ย้าย readBody → _readBody (private)                                                                              │
│   // ลบ runDartScript ออกทั้งหมด                                                                                       │
│ }                                                                                                                    │
│                                                                                                                      │
│ 2.2 main() ใช้ PipelineController                                                                                     │
│                                                                                                                      │
│ void main() async {                                                                                                  │
│   final controller = PipelineController();                                                                           │
│   final server = await HttpServer.bind(InternetAddress.loopbackIPv4, 8080);                                          │
│   await for (final request in server) {                                                                              │
│     // CORS + error handling เหมือนเดิม                                                                                │
│     await controller.handleRequest(request);                                                                         │
│   }                                                                                                                  │
│ }                                                                                                                    │
│                                                                                                                      │
│ 2.3 Handler changes: Process.run → direct method calls                                                               │
│                                                                                                                      │
│ handleScan / handleExtractManifest:                                                                                  │
│ // Before: runDartScript('tools/.../extract_ui_manifest.dart', [file])                                               │
│ // After:                                                                                                            │
│ try {                                                                                                                │
│   final manifestPath = _extractor.extractManifest(file);                                                             │
│   // ...success response...                                                                                          │
│ } catch (e) {                                                                                                        │
│   // ...error response...                                                                                            │
│ }                                                                                                                    │
│                                                                                                                      │
│ handleGenerateDatasets:                                                                                              │
│ // Before: runDartScript('tools/.../generate_datasets.dart', [manifest])                                             │
│ // After:                                                                                                            │
│ final datasetsPath = await _datasetGenerator.generateDatasets(manifest);                                             │
│ if (datasetsPath == null) { /* skipped */ } else { /* success */ }                                                   │
│                                                                                                                      │
│ handleGenerateTestData (ลบ temp file workaround):                                                                    │
│ // Before: สร้าง .tmp_constraints.txt → runDartScript(..., ['--constraints-file', ...]) → ลบ temp                     │
│ // After:                                                                                                            │
│ final testDataPath = await _testDataGenerator.generateTestData(                                                      │
│   manifest, constraints: constraints,                                                                                │
│ );                                                                                                                   │
│                                                                                                                      │
│ handleGenerateTestScript:                                                                                            │
│ final testScriptPath = _testScriptGenerator.generateTestScript(testData);                                            │
│                                                                                                                      │
│ handleGenerateAll (4 steps → direct calls):                                                                          │
│ // Step 1                                                                                                            │
│ for (final f in pageFiles) _extractor.extractManifest(f);                                                            │
│ // Step 2                                                                                                            │
│ for (final m in manifests) await _datasetGenerator.generateDatasets(m);                                              │
│ // Step 3                                                                                                            │
│ for (final m in manifests) await _testDataGenerator.generateTestData(m);                                             │
│ // Step 4                                                                                                            │
│ for (final t in testDataFiles) _testScriptGenerator.generateTestScript(t);                                           │
│                                                                                                                      │
│ 2.4 What stays as Process.run in server.dart                                                                         │
│                                                                                                                      │
│ - flutter test → handleRunTests                                                                                      │
│ - flutter devices --machine → handleRunTests                                                                         │
│ - lcov --remove → handleRunTests                                                                                     │
│ - genhtml → handleRunTests                                                                                           │
│ - open / xdg-open / explorer → handleRunTests, handleOpenCoverage                                                    │
│                                                                                                                      │
│ Verification                                                                                                         │
│                                                                                                                      │
│ After each phase, validate:                                                                                          │
│                                                                                                                      │
│ Phase 1 - CLI scripts still work:                                                                                    │
│ dart run tools/script_v2/extract_ui_manifest.dart lib/demos/customer_details_page.dart                               │
│ dart run tools/script_v2/generate_test_data.dart output/manifest/demos/customer_details_page.manifest.json           │
│ dart run tools/script_v2/generate_test_script.dart output/test_data/customer_details_page.testdata.json              │
│                                                                                                                      │
│ Phase 2 - Server + frontend still work:                                                                              │
│ dart run webview/server.dart                                                                                         │
│ # Open http://localhost:8080 → select file → Generate → Run Coverage                                                 │
│                                                                                                                      │
│ Final - API contract unchanged (all endpoints return same JSON format as before)   