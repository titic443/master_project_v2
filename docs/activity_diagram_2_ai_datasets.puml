@startuml
title Activity Diagram 2: การสร้างข้อมูลทดสอบด้วยระบบเอไอ
skinparam defaultTextAlignment center
skinparam activityBackgroundColor #E8F5E9
skinparam activityBorderColor #388E3C
skinparam decisionBackgroundColor #FFF9C4
skinparam decisionBorderColor #F57F17
skinparam swimlaneWidth 350

|ระบบ|
start

:รับ Input Manifest Path;
note right
  **Input:**
  output/manifest/**/*.manifest.json
end note

if (มี arguments?) then (yes)
  :ใช้ไฟล์ที่ระบุ;
else (no)
  :Scan output/manifest/\nหาทุกไฟล์ .manifest.json;
endif

partition "สำหรับแต่ละ Manifest" {
  :อ่าน Manifest JSON;

  :ตรวจสอบ API Key\n(--api-key > .env > ENV > hardcoded);
  note right
    **API Key Priority:**
    1. --api-key flag
    2. .env file
    3. Environment variable
    4. Hardcoded constant
  end note

  :สแกน TextField/TextFormField\nจาก widgets[];

  if (พบ TextField?) then (no)
    :⊘ Skip (No text fields);
    stop
  else (yes)
    :รวม ALL fields\n(ทั้ง with/without rules);
  endif

  :เช็ค API Key (บังคับ);
  note right
    **CRITICAL:**
    ทุก TextField ต้องใช้ AI
    ไม่มี local generation
  end note

  if (มี API Key?) then (no)
    :❌ Error: GEMINI_API_KEY Required;
    stop
  else (yes)
    |Gemini API|
    :สร้าง AI Prompt:\n- Fields WITHOUT rules: สร้าง valid เท่านั้น\n- Fields WITH rules: สร้าง valid/invalid pairs;
    note right
      **Prompt Structure:**

      **For fields WITHOUT validatorRules:**
      - สร้าง 1 realistic valid value
      - invalid = empty string
      - invalidRuleMessages = empty string

      **For fields WITH validatorRules:**
      1. วิเคราะห์ constraints
      2. กรอง isEmpty/null rules
      3. สร้าง N pairs (N=จำนวน non-empty rules)
      4. Invalid ต้อง pass inputFormatters
         แต่ fail validators
      5. Output: JSON เท่านั้น
    end note

    :ส่ง HTTP POST\nไปยัง Gemini API;

    if (API Success?) then (yes)
      :รับ Response JSON;
      :ลบ markdown code fences;
      :แปลง JSON String\nเป็น Object;
      :Normalize ด้วย maxLength;
      :สร้าง byKey datasets;
    else (no)
      :❌ Error: Gemini API Failed;
      stop
    endif
  endif

  :สร้าง Output JSON\n= {file, datasets};
  note right
    **โครงสร้าง:**
    {
      "file": "lib/demos/xxx_page.dart",
      "datasets": {
        "byKey": {
          "<key>": [
            {
              "valid": "...",
              "invalid": "...",
              "invalidRuleMessages": "..."
            }
          ]
        }
      }
    }
  end note

  :คำนวณ Output Path\n= output/test_data/<page>.datasets.json;

  :เขียนไฟล์ JSON;

  :แสดงข้อความสำเร็จ\n"✓ Generated: <path>";
}

:Output: Datasets Files;
note right
  **Output Path:**
  output/test_data/*.datasets.json

  **Format (Array of Objects):**
  - ALL fields ใช้รูปแบบเดียวกัน: array of objects
  - fieldsWithoutRules: [{"valid":"...", "invalid":"", "invalidRuleMessages":""}]
  - fieldsWithRules: [{"valid":"...", "invalid":"...", "invalidRuleMessages":"..."}]

  **Example:**
  {
    "file": "lib/demos/customer_details_page.dart",
    "datasets": {
      "byKey": {
        "comment_textfield": [
          {
            "valid": "This is a sample comment",
            "invalid": "",
            "invalidRuleMessages": ""
          }
        ],
        "customer_02_firstname_textfield": [
          {
            "valid": "Alice",
            "invalid": "A",
            "invalidRuleMessages": "Min 2 chars"
          },
          {
            "valid": "Bob",
            "invalid": "B@",
            "invalidRuleMessages": "Letters only"
          }
        ]
      }
    }
  }
end note

stop

@enduml
